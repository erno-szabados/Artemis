<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
	<head>
		<meta name='viewport' content='width=device-width, initial-scale=1.0' />
		<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
		<title>DEFINITION DUtf8Strings</title>
		<link rel='stylesheet' type='text/css' href='style.css' />
	</head>
	<body>
		<p><a href='index.html'>Index</a></p>

		<pre>
<span class='comment'>(* DUtf8Strings.Mod implements a dynamic UTF-8 string with Rider support in Oberon-7.

Copyright (C) 2025 Artemis Project

Released under The 3-Clause BSD License.
See https://opensource.org/licenses/BSD-3-Clause
*)</span>
DEFINITION <em>DUtf8Strings</em>;

IMPORT Collections;

TYPE
  <span class='comment'>(* DUtf8String implements a dynamic UTF-8 string as a linked list of codepoints.
      Each node stores one UTF-8 codepoint (1-4 bytes) with proper encoding. *)</span>
  DUtf8String = POINTER TO DUtf8StringDesc;
  DUtf8StringDesc = RECORD (Collections.Item) END;

  <span class='comment'>(* Rider provides file-like interface for traversing/modifying DUtf8String.
      All positions are in Unicode codepoints, not bytes. *)</span>
  Rider = RECORD
    pos: INTEGER;
    eot: BOOLEAN
  END;

<span class='comment'>(* Init takes an ARRAY OF CHAR (UTF-8 encoded) and initializes a DUtf8String.
    The source array is expected to contain valid UTF-8. *)</span>
PROCEDURE <em>Init</em>(source: ARRAY OF CHAR; VAR s: DUtf8String);

<span class='comment'>(* Length returns the number of Unicode codepoints in the string. *)</span>
PROCEDURE <em>Length</em>(s: DUtf8String): INTEGER;

<span class='comment'>(* Set initializes a Rider to position pos (in codepoints) in the string. *)</span>
PROCEDURE <em>Set</em>(VAR r: Rider; s: DUtf8String; pos: INTEGER);

<span class='comment'>(* Base returns the string the Rider operates on. *)</span>
PROCEDURE <em>Base</em>(r: Rider): DUtf8String;

<span class='comment'>(* Get returns the current codepoint and advances the Rider. *)</span>
PROCEDURE <em>Get</em>(VAR r: Rider): INTEGER;

<span class='comment'>(* ToChars converts the DUtf8String to an ARRAY OF CHAR (UTF-8 encoded).
    Returns the number of bytes that were truncated due to insufficient space. *)</span>
PROCEDURE <em>ToChars</em>(s: DUtf8String; VAR dest: ARRAY OF CHAR; VAR truncated: INTEGER);

<span class='comment'>(* Copy duplicates the source string into dest, allocating as needed. *)</span>
PROCEDURE <em>Copy</em>(source: DUtf8String; VAR dest: DUtf8String);

<span class='comment'>(* Clear sets the string to empty (single node with 0X codepoint). *)</span>
PROCEDURE <em>Clear</em>(VAR s: DUtf8String);

<span class='comment'>(* CopyChars copies an ARRAY OF CHAR (UTF-8 encoded) into a DUtf8String. *)</span>
PROCEDURE <em>CopyChars</em>(source: ARRAY OF CHAR; VAR dest: DUtf8String);

<span class='comment'>(* Extract extracts count codepoints from source starting at position pos. *)</span>
PROCEDURE <em>Extract</em>(source: DUtf8String; pos, count: INTEGER; VAR dest: DUtf8String);

<span class='comment'>(* Append appends source string to the end of dest. *)</span>
PROCEDURE <em>Append</em>(source: DUtf8String; VAR dest: DUtf8String);

<span class='comment'>(* Insert inserts source string at position pos (in codepoints) in dest. *)</span>
PROCEDURE <em>Insert</em>(source: DUtf8String; pos: INTEGER; VAR dest: DUtf8String);

<span class='comment'>(* Delete deletes count codepoints from string s starting at position pos. *)</span>
PROCEDURE <em>Delete</em>(VAR s: DUtf8String; pos, count: INTEGER);

<span class='comment'>(* Pos returns the codepoint position of first occurrence of pattern in source, or -1 if not found. *)</span>
PROCEDURE <em>Pos</em>(pattern, source: DUtf8String; startPos: INTEGER): INTEGER;

<span class='comment'>(* Replaces the first occurrence of pattern in source with substitute. *)</span>
PROCEDURE <em>Replace</em>(pattern, substitute: DUtf8String; VAR source: DUtf8String);

<span class='comment'>(* Equal compares two DUtf8String values for equality. *)</span>
PROCEDURE <em>Equal</em>(s1, s2: DUtf8String): BOOLEAN;

<span class='comment'>(* StartsWith checks if source string starts with prefix *)</span>
PROCEDURE <em>StartsWith</em>(prefix, source: DUtf8String): BOOLEAN;

<span class='comment'>(* EndsWith checks if source string ends with suffix *)</span>
PROCEDURE <em>EndsWith</em>(suffix, source: DUtf8String): BOOLEAN;

<span class='comment'>(* Cap converts lowercase ASCII letters (a-z) to uppercase (A-Z) in place.
    UTF-8 characters beyond ASCII are left unchanged. *)</span>
PROCEDURE <em>Cap</em>(VAR s: DUtf8String);

<span class='comment'>(* Peek returns the current codepoint without advancing the rider position.
    Returns 0 if at end of string or on invalid UTF-8. *)</span>
PROCEDURE <em>Peek</em>(r: Rider): INTEGER;

<span class='comment'>(* Put writes a codepoint at the current rider position and advances.
    Allocates new nodes as needed for string expansion. *)</span>
PROCEDURE <em>Put</em>(VAR r: Rider; codePoint: INTEGER);

<span class='comment'>(* TrimPrefix removes prefix from beginning of source if it matches *)</span>
PROCEDURE <em>TrimPrefix</em>(prefix: DUtf8String; VAR source: DUtf8String);

<span class='comment'>(* TrimSuffix removes suffix from end of source if it matches *)</span>
PROCEDURE <em>TrimSuffix</em>(suffix: DUtf8String; VAR source: DUtf8String);

<span class='comment'>(* TrimString removes cutString from both beginning and end of source *)</span>
PROCEDURE <em>TrimString</em>(cutString: DUtf8String; VAR source: DUtf8String);

<span class='comment'>(* TrimLeft removes codepoints from beginning of source if they match any in cutset *)</span>
PROCEDURE <em>TrimLeft</em>(cutset: ARRAY OF INTEGER; cutsetLen: INTEGER; VAR source: DUtf8String);

<span class='comment'>(* TrimRight removes codepoints from end of source if they match any in cutset *)</span>
PROCEDURE <em>TrimRight</em>(cutset: ARRAY OF INTEGER; cutsetLen: INTEGER; VAR source: DUtf8String);

<span class='comment'>(* Trim removes codepoints from both ends of source if they match any in cutset *)</span>
PROCEDURE <em>Trim</em>(cutset: ARRAY OF INTEGER; cutsetLen: INTEGER; VAR source: DUtf8String);

<span class='comment'>(* TrimSpaces removes Unicode whitespace characters from both ends *)</span>
PROCEDURE <em>TrimSpaces</em>(VAR source: DUtf8String);

<span class='comment'>(* Quote adds leftQuote at beginning and rightQuote at end of string *)</span>
PROCEDURE <em>Quote</em>(leftQuote, rightQuote: INTEGER; VAR source: DUtf8String);

<span class='comment'>(* Prune removes trailing nodes after the first node with 0X terminator.
    This helps with memory optimization after string operations. *)</span>
PROCEDURE <em>Prune</em>(VAR s: DUtf8String);

END DUtf8Strings.
</pre>
	</body>
</html>
