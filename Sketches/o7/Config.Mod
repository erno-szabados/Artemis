(** Config.Mod provides defaults with OS environment overriders.

Copyright (C) 2021 R. S. Doiel <rsdoiel@gmail.com> This Source Code Form is subject to the terms of the Mozilla PublicLicense, v. 2.0. If a copy of the MPL was not distributed with thisfile, You can obtain one at http://mozilla.org/MPL/2.0/. *)
MODULE Config;

(** NOTE: cfg is generated by the script mkcfg.sh based on the host
    system or command line options *)
IMPORT cfg, Env := extEnv, Args := extArgs, Strings;

CONST
  MAXSTR* = 2024;

VAR
  version* : ARRAY 64 OF CHAR;
  (** The following provide defaults for the modules that include Config. *)
  os* : ARRAY 12 OF CHAR;
  arch* : ARRAY 12 OF CHAR;
  prefix* : ARRAY MAXSTR OF CHAR;
  libDir* : ARRAY MAXSTR OF CHAR;
  argCount* : INTEGER;
  appName* : ARRAY 512 OF CHAR;

(** Init reads the environment updates the values for
    os, arch, prefix and libDir based on environment variables
    OBNC_TARGET_OS, OBNC_TARGET_ARCH, OBNC_PREFIX and OBNC_LIBDIR. *)
PROCEDURE Init*();
  VAR val : ARRAY MAXSTR OF CHAR; res : INTEGER;
BEGIN 
  (* Pickup the default configuration *)
  Strings.Append(cfg.version, version);
  Strings.Append(cfg.os, os);
  Strings.Append(cfg.arch, arch);
  (* Read settings from the environment *)
  argCount := Args.count;
  Args.GetAppName(appName, res);
  Env.Get("OBNC_TARGET_OS", val, res);
  IF Strings.Length(val) > 0 THEN
    os[0] := 0X; Strings.Append(val, os);
  END;
  Env.Get("OBNC_TARGET_ARCH", val, res);
  IF Strings.Length(val) > 0 THEN
    arch[0] := 0X; Strings.Append(val, arch);
  END;
  Env.Get("OBNC_PREFIX", val, res);
  IF Strings.Length(val) > 0 THEN
    prefix[0] := 0X; Strings.Append(val, prefix);
  END;
  Env.Get("OBNC_LIBDIR", val, res);
  IF Strings.Length(val) > 0 THEN
    libDir[0] := 0X; Strings.Append(val, libDir);
  END;
END Init;

(** GetArg returns the argument for a given position on the command line *)
PROCEDURE GetArg*(n : INTEGER; VAR arg : ARRAY OF CHAR; VAR res : INTEGER);
BEGIN
  Args.Get(n, arg, res);
END GetArg;

BEGIN 
  version[0] := 0X; os[0] := 0X; arch[0] := 0X;
  prefix[0] := 0X; libDir[0] := 0X;
  appName[0] := 0X;
  argCount := 0;
END Config.
